<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f7fafc;
      color: #2d3748;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .header-nav {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .header-nav a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: opacity 0.2s;
    }

    .header-nav a:hover {
      opacity: 0.8;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .page-title {
      margin-bottom: 30px;
    }

    .page-title h2 {
      font-size: 28px;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .page-title p {
      color: #718096;
      font-size: 16px;
    }

    .status-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-trial {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-cancelled {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-past-due {
      background: #fef3c7;
      color: #92400e;
    }

    .status-info {
      font-size: 16px;
      color: #4a5568;
      line-height: 1.6;
    }

    .status-info strong {
      color: #2d3748;
    }

    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .plan-card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .plan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }

    .plan-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .plan-name {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .plan-price {
      font-size: 42px;
      font-weight: 800;
      color: #667eea;
      margin-bottom: 5px;
    }

    .plan-price small {
      font-size: 18px;
      font-weight: 500;
      color: #718096;
    }

    .plan-savings {
      font-size: 14px;
      color: #10b981;
      font-weight: 600;
    }

    .plan-features {
      list-style: none;
      margin: 20px 0;
    }

    .plan-features li {
      padding: 10px 0;
      color: #4a5568;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plan-features li::before {
      content: "‚úì";
      color: #10b981;
      font-weight: 700;
      font-size: 18px;
    }

    .btn-subscribe {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-subscribe:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-subscribe:active {
      transform: translateY(0);
    }

    .btn-subscribe:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-cancel {
      width: 100%;
      padding: 15px;
      background: white;
      color: #dc2626;
      border: 2px solid #dc2626;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
    }

    .btn-cancel:hover {
      background: #dc2626;
      color: white;
    }

    .btn-portal {
      width: 100%;
      padding: 15px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
      text-decoration: none;
      display: block;
      text-align: center;
    }

    .btn-portal:hover {
      background: #667eea;
      color: white;
    }

    .alert-warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      color: #92400e;
    }

    .alert-info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      color: #1e40af;
    }

    .alert-success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
      color: #065f46;
    }

    #loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
      }

      .plans-grid {
        grid-template-columns: 1fr;
      }

      .plan-card {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>üéØ FilterFive</h1>
      <nav class="header-nav">
        <a href="/dashboard">Dashboard</a>
        <a href="/dashboard/feedback">Feedback</a>
        <a href="/dashboard/settings">Settings</a>
        <a href="/dashboard/subscription">Subscription</a>
        <a href="/dashboard/logout">Logout</a>
        <a href="/privacy" target="_blank" style="font-size: 0.9rem;">Privacy</a>
        <a href="/terms" target="_blank" style="font-size: 0.9rem;">Terms</a>
      </nav>
    </div>
  </div>

  <div class="container">
    <div class="page-title">
      <h2>Subscription üí≥</h2>
      <p>Manage your FilterFive subscription and billing</p>
    </div>

    <!-- Current Status Card -->
    <div class="status-card">
      <% if (trialStatus.hasActiveSubscription) { %>
        <span class="status-badge status-active">‚úì Active Subscription</span>
        <div class="status-info">
          <p><strong>Plan:</strong> <%= user.subscriptionPlan === 'monthly' ? 'Monthly ($77/mo)' : 'Annual ($770/yr)' %></p>
          <% if (subscriptionDetails && subscriptionDetails.current_period_end) { %>
            <p><strong>Next billing date:</strong> <%= new Date(subscriptionDetails.current_period_end * 1000).toLocaleDateString() %></p>
          <% } %>
          <p><strong>SMS Sent:</strong> <%= user.smsUsageCount %> / <%= user.smsUsageLimit %></p>
        </div>
      <% } else if (trialStatus.isActive) { %>
        <span class="status-badge status-trial">üéÅ Free Trial Active</span>
        <div class="status-info">
          <p><strong>Trial ends:</strong> <%= new Date(trialStatus.trialEndsAt).toLocaleDateString() %></p>
          <p><strong>SMS Sent:</strong> <%= user.smsUsageCount %> / <%= user.smsUsageLimit %></p>
          <p>Upgrade to unlock 1,000 SMS per month!</p>
        </div>
      <% } else if (trialStatus.isInGracePeriod) { %>
        <span class="status-badge status-past-due">‚ö†Ô∏è Trial Expired - Grace Period</span>
        <div class="alert-warning">
          <strong>Your trial has expired.</strong><br>
          You have a 5-day grace period to upgrade. After that, your account will be locked.
        </div>
      <% } else if (trialStatus.isHardLocked) { %>
        <span class="status-badge status-cancelled">üîí Account Locked</span>
        <div class="alert-warning">
          <strong>Your account is locked.</strong><br>
          Please upgrade to a paid plan to continue using FilterFive.
        </div>
      <% } else if (user.subscriptionStatus === 'cancelled') { %>
        <span class="status-badge status-cancelled">Cancelled</span>
        <div class="status-info">
          <p>Your subscription has been cancelled.</p>
          <% if (subscriptionDetails && subscriptionDetails.current_period_end) { %>
            <p><strong>Access until:</strong> <%= new Date(subscriptionDetails.current_period_end * 1000).toLocaleDateString() %></p>
          <% } %>
        </div>
      <% } else if (user.subscriptionStatus === 'past_due') { %>
        <span class="status-badge status-past-due">‚ö†Ô∏è Payment Failed</span>
        <div class="alert-warning">
          <strong>Your last payment failed.</strong><br>
          Please update your payment method to avoid service interruption.
        </div>
      <% } %>
    </div>

    <!-- Show pricing plans if no active subscription -->
    <% if (!trialStatus.hasActiveSubscription) { %>
      <div class="alert-info">
        <strong>üí° Choose your plan</strong><br>
        Both plans include unlimited feedback requests, QR codes, and 1,000 SMS per month.
      </div>

      <div class="plans-grid">
        <!-- Monthly Plan -->
        <div class="plan-card">
          <div class="plan-header">
            <div class="plan-name">Monthly</div>
            <div class="plan-price">
              $77<small>/mo</small>
            </div>
          </div>

          <ul class="plan-features">
            <li>1,000 SMS messages/month</li>
            <li>Unlimited feedback requests</li>
            <li>Unlimited QR codes</li>
            <li>Email notifications</li>
            <li>Review filtering & capture</li>
            <li>Cancel anytime</li>
          </ul>

          <button class="btn-subscribe" onclick="checkout('monthly', event)">
            Subscribe Monthly
          </button>
        </div>

        <!-- Annual Plan -->
        <div class="plan-card">
          <div class="plan-header">
            <div class="plan-name">Annual</div>
            <div class="plan-price">
              $770<small>/yr</small>
            </div>
            <div class="plan-savings">Save $154/year (2 months free!)</div>
          </div>

          <ul class="plan-features">
            <li>1,000 SMS messages/month</li>
            <li>Unlimited feedback requests</li>
            <li>Unlimited QR codes</li>
            <li>Email notifications</li>
            <li>Review filtering & capture</li>
            <li>Priority support</li>
          </ul>

          <button class="btn-subscribe" onclick="checkout('annual', event)">
            Subscribe Annually
          </button>
        </div>
      </div>
    <% } %>

    <!-- Subscription Management (if active) -->
    <% if (trialStatus.hasActiveSubscription) { %>
      <div class="status-card">
        <h3 style="margin-bottom: 15px; color: #2d3748;">Manage Subscription</h3>

        <a href="/dashboard/subscription/portal" class="btn-portal">
          Manage Billing & Payment Methods
        </a>

        <button class="btn-cancel" onclick="cancelSubscription()">
          Cancel Subscription
        </button>

        <p style="margin-top: 15px; font-size: 13px; color: #718096; text-align: center;">
          Cancelling will disable your subscription at the end of the current billing period.
        </p>
      </div>
    <% } %>

    <div id="loading">Processing...</div>

    <!-- Footer -->
    <footer class="footer" style="margin-top: 60px; padding-top: 40px; border-top: 1px solid #e2e8f0; text-align: center; font-size: 14px; color: #718096;">
      <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
        <a href="/terms" target="_blank" style="color: #667eea; text-decoration: none;">Terms of Service</a>
        <a href="/privacy" target="_blank" style="color: #667eea; text-decoration: none;">Privacy Policy</a>
        <a href="/sms-compliance" target="_blank" style="color: #667eea; text-decoration: none;">SMS Compliance</a>
      </div>
      <p>&copy; 2025 FilterFive. All rights reserved.</p>
    </footer>
  </div>

  <script>
    const stripe = Stripe('<%= stripePubKey %>');

    async function checkout(plan, event) {
      const button = event.target;
      button.disabled = true;
      button.textContent = 'Processing...';
      document.getElementById('loading').style.display = 'block';

      try {
        const response = await fetch('/dashboard/subscription/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ plan })
        });

        const data = await response.json();

        if (data.success) {
          // Redirect to Stripe Checkout
          window.location.href = data.url;
        } else {
          alert('Error: ' + data.error);
          button.disabled = false;
          button.textContent = plan === 'monthly' ? 'Subscribe Monthly' : 'Subscribe Annually';
          document.getElementById('loading').style.display = 'none';
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        button.disabled = false;
        button.textContent = plan === 'monthly' ? 'Subscribe Monthly' : 'Subscribe Annually';
        document.getElementById('loading').style.display = 'none';
      }
    }

    async function cancelSubscription() {
      if (!confirm('Are you sure you want to cancel your subscription? You will retain access until the end of your billing period.')) {
        return;
      }

      document.getElementById('loading').style.display = 'block';

      try {
        const response = await fetch('/dashboard/subscription/cancel-subscription', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ immediately: false })
        });

        const data = await response.json();

        if (data.success) {
          alert(data.message);
          window.location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }
  </script>
</body>
</html>
