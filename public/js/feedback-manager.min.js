!function(){"use strict";let e=null,t=null,n="asc";function o(e,t,n){const o=document.getElementById("alertBox"),r=document.getElementById("alertIcon"),s=document.getElementById("alertTitle"),c=document.getElementById("alertMessage");o.className="alert show "+e,r.textContent="success"===e?"✅":"❌",s.textContent=t,c.textContent=n,setTimeout(a,5e3)}function a(){document.getElementById("alertBox").classList.remove("show")}function r(){const e=document.getElementById("ratingFilter").value,t=document.getElementById("statusFilter").value,n=document.getElementById("dateRangeFilter").value,o=document.getElementById("hasFeedbackFilter").value,a=document.getElementById("searchFilter").value,r=new URLSearchParams({rating:e,status:t,dateRange:n,hasFeedback:o,search:a,page:1});window.location.href="/dashboard/feedback?"+r.toString()}function s(e){"Enter"===e.key&&r()}function c(e){const t=new URL(window.location.href);t.searchParams.set("page",e),window.location.href=t.toString()}function d(){const e=document.getElementById("limitSelect").value,t=new URL(window.location.href);t.searchParams.set("limit",e),t.searchParams.set("page",1),window.location.href=t.toString()}function l(e){const o=document.getElementById("feedbackTable");if(!o)return;const a=o.querySelector("tbody"),r=Array.from(a.querySelectorAll("tr"));t===e?n="asc"===n?"desc":"asc":(t=e,n="asc"),o.querySelectorAll("th").forEach(function(e){e.classList.remove("sorted-asc","sorted-desc")});const s=o.querySelector('th[data-column="'+e+'"]');s&&s.classList.add("asc"===n?"sorted-asc":"sorted-desc");const c={date:1,customer:2,phone:3,rating:4,status:6}[e];r.sort(function(t,o){const a=t.cells[c].getAttribute("data-sort")||t.cells[c].textContent.trim(),r=o.cells[c].getAttribute("data-sort")||o.cells[c].textContent.trim();return"date"===e||"rating"===e?"asc"===n?parseFloat(a)-parseFloat(r):parseFloat(r)-parseFloat(a):"asc"===n?a.localeCompare(r):r.localeCompare(a)}),r.forEach(function(e){a.appendChild(e)})}function i(e,t){if(e.classList.contains("no-feedback"))return;if(e.classList.contains("expanded")){const t=e.getAttribute("data-full");e.textContent=t.length>100?t.substring(0,100)+"...":t,e.classList.remove("expanded"),e.classList.add("truncated")}else{const n=e.getAttribute("data-full");e.textContent=n,e.classList.remove("truncated"),e.classList.add("expanded"),function(e){fetch("/dashboard/feedback/"+e+"/view",{method:"POST",headers:{"Content-Type":"application/json"}}).then(function(e){if(e.ok)return e.json();throw new Error("Failed to mark as viewed")}).then(function(t){var n=document.querySelector('tr[data-review-id="'+e+'"]');if(n&&"viewed"===t.status){var o=n.querySelector(".status-badge");o&&"new"===o.textContent.trim()&&(o.textContent="viewed",o.className="status-badge status-viewed")}}).catch(function(e){console.error("Failed to mark as viewed:",e)})}(t)}}function u(e,t){e.stopPropagation(),document.querySelectorAll(".actions-menu").forEach(function(e){e!==t.nextElementSibling&&e.classList.remove("show")}),t.nextElementSibling.classList.toggle("show")}function m(){var e=document.getElementById("selectAll");document.querySelectorAll(".row-checkbox").forEach(function(t){t.checked=e.checked}),g()}function g(){var e=document.querySelectorAll(".row-checkbox:checked").length,t=document.getElementById("bulkActionsBar"),n=document.getElementById("selectedCount");n&&(n.textContent=e),t&&(e>0?t.classList.add("show"):t.classList.remove("show"));var o=document.querySelectorAll(".row-checkbox"),a=document.getElementById("selectAll");a&&(a.checked=e===o.length&&e>0)}function h(){document.querySelectorAll(".row-checkbox").forEach(function(e){e.checked=!1});var e=document.getElementById("selectAll");e&&(e.checked=!1),g()}function f(e){var t=document.querySelectorAll(".row-checkbox:checked"),n=Array.from(t).map(function(e){return parseInt(e.dataset.reviewId)});0!==n.length?confirm("Mark "+n.length+" feedback item(s) as "+e+"?")&&fetch("/dashboard/feedback/bulk-update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reviewIds:n,status:e})}).then(function(e){return e.json().then(function(t){return{ok:e.ok,data:t}})}).then(function(t){t.ok?(o("success","Success",t.data.message),n.forEach(function(t){var n=document.querySelector('tr[data-review-id="'+t+'"]');if(n){var o=n.querySelector(".status-badge");o.textContent=e,o.className="status-badge status-"+e}}),h()):o("error","Error",t.data.error||"Failed to update status")}).catch(function(e){o("error","Error","Failed to update status")}):o("error","Error","No feedback items selected")}function w(e,t){fetch("/dashboard/feedback/"+e+"/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:t})}).then(function(e){return e.json().then(function(t){return{ok:e.ok,data:t}})}).then(function(n){if(n.ok){o("success","Success",n.data.message);var a=document.querySelector('tr[data-review-id="'+e+'"]');if(a){var r=a.querySelector(".status-badge");r.textContent=t,r.className="status-badge status-"+t}}else o("error","Error",n.data.error||"Failed to update status")}).catch(function(e){o("error","Error","Failed to update status")})}function p(t,n,o,a){e=t,document.getElementById("respondCustomerName").textContent=n,document.getElementById("respondCustomerPhone").textContent=o,document.getElementById("respondOriginalFeedback").textContent=a||"No feedback text",document.getElementById("respondMessage").value="",y(),document.getElementById("respondModal").classList.add("show")}function y(){var e=document.getElementById("respondMessage"),t=document.getElementById("charCount");if(e&&t){var n=e.value.length,o=Math.ceil(n/160)||1;t.textContent=n+" / 320 characters ("+o+" SMS)",n>320?(t.classList.add("error"),t.classList.remove("warning")):n>270?(t.classList.add("warning"),t.classList.remove("error")):t.classList.remove("warning","error")}}function v(e){document.getElementById("respondMessage").value=e,y()}function S(){var t=document.getElementById("respondMessage").value.trim();if(t)if(t.length>320)o("error","Error","Message is too long (max 320 characters)");else{var n=document.getElementById("sendSmsBtn"),a=document.getElementById("sendBtnText");n.disabled=!0,a.innerHTML='<span class="loading-spinner"></span> Sending...',fetch("/dashboard/feedback/"+e+"/respond",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})}).then(function(e){return e.json().then(function(t){return{ok:e.ok,data:t}})}).then(function(t){if(t.ok){o("success","Success","SMS sent successfully!"),k("respondModal");var n=document.querySelector('tr[data-review-id="'+e+'"]');if(n){var a=n.querySelector(".status-badge");a.textContent="responded",a.className="status-badge status-responded"}}else o("error","Error",t.data.error||"Failed to send SMS")}).catch(function(e){o("error","Error","Failed to send SMS")}).finally(function(){n.disabled=!1,a.textContent="Send SMS"})}else o("error","Error","Please enter a message")}function E(t,n){e=t;var o=document.getElementById("notesHistory");if(n&&n.trim()){var a=n.split("\n\n").filter(function(e){return e.trim()});o.innerHTML=a.map(function(e){var t=e.match(/\[(.*?)\] (.*)/s);return t?'<div class="note-item"><div class="note-timestamp">'+new Date(t[1]).toLocaleString()+'</div><div class="note-content">'+t[2]+"</div></div>":'<div class="note-item"><div class="note-content">'+e+"</div></div>"}).join("")}else o.innerHTML='<div style="text-align: center; color: #a0aec0; padding: 20px;">No notes yet</div>';document.getElementById("newNoteText").value="",document.getElementById("notesModal").classList.add("show")}function b(){var t=document.getElementById("newNoteText").value.trim();t?fetch("/dashboard/feedback/"+e+"/note",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note:t})}).then(function(e){return e.json().then(function(t){return{ok:e.ok,data:t}})}).then(function(e){e.ok?(o("success","Success","Note added successfully"),k("notesModal")):o("error","Error",e.data.error||"Failed to add note")}).catch(function(e){o("error","Error","Failed to add note")}):o("error","Error","Please enter a note")}function k(t){document.getElementById(t).classList.remove("show"),e=null}function B(){var e=new URL("/dashboard/feedback/export",window.location.origin),t=new URL(window.location.href).searchParams;["rating","status","dateRange","search"].forEach(function(n){var o=t.get(n);o&&e.searchParams.set(n,o)}),window.location.href=e.toString()}function x(){document.addEventListener("click",function(){document.querySelectorAll(".actions-menu").forEach(function(e){e.classList.remove("show")})}),document.querySelectorAll(".modal-overlay").forEach(function(e){e.addEventListener("click",function(t){t.target===e&&e.classList.remove("show")})});var e=document.getElementById("respondMessage");e&&e.addEventListener("input",y),g()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",x):x(),window.FeedbackManager={showAlert:o,hideAlert:a,applyFilters:r,handleSearchKeyup:s,changePage:c,changeLimit:d,sortTable:l,toggleFeedback:i,toggleActionsMenu:u,toggleSelectAll:m,updateBulkActions:g,clearSelection:h,bulkUpdateStatus:f,updateSingleStatus:w,openRespondModal:p,updateCharCount:y,useTemplate:v,sendResponse:S,openNotesModal:E,addNote:b,closeModal:k,exportFeedback:B},window.showAlert=o,window.hideAlert=a,window.applyFilters=r,window.handleSearchKeyup=s,window.changePage=c,window.changeLimit=d,window.sortTable=l,window.toggleFeedback=i,window.toggleActionsMenu=u,window.toggleSelectAll=m,window.updateBulkActions=g,window.clearSelection=h,window.bulkUpdateStatus=f,window.updateSingleStatus=w,window.openRespondModal=p,window.updateCharCount=y,window.useTemplate=v,window.sendResponse=S,window.openNotesModal=E,window.addNote=b,window.closeModal=k,window.exportFeedback=B}();