!function(){"use strict";var e="/api/analytics",t=30,n=null;function a(){!function(){document.querySelectorAll(".filter-btn").forEach(function(e){e.addEventListener("click",function(e){document.querySelectorAll(".filter-btn").forEach(function(e){e.classList.remove("active")}),e.target.classList.add("active"),t=parseInt(e.target.dataset.range),i()})});var e=document.getElementById("location-filter");e&&e.addEventListener("change",function(e){n=e.target.value||null,i(),c()})}(),i(),c()}function i(){var a=new Date,i=new Date;i.setDate(i.getDate()-t);var c=new URLSearchParams({startDate:i.toISOString().split("T")[0],endDate:a.toISOString().split("T")[0]});n&&c.append("location",n),Promise.all([fetch(e+"/metrics?"+c),fetch(e+"/trends?"+c)]).then(function(e){return Promise.all(e.map(function(e){return e.json()}))}).then(function(e){var t=e[0],n=e[1];!function(e){var t=document.getElementById("roi-display"),n=document.getElementById("cost-per-review"),a=document.getElementById("value-generated"),i=document.getElementById("net-value");t&&(t.textContent=e.roiFormatted||"+0%");n&&(n.textContent=d(e.costPerReview));a&&(a.textContent=d(e.valueGenerated));i&&(i.textContent=d(e.netValue))}(t.roi),function(e,t){var n=e.reviews.averageRating||0,a=document.getElementById("avg-rating"),i=document.getElementById("rating-subtext");a&&(a.textContent=n.toFixed(1));i&&(i.textContent=e.reviews.positive+" positive reviews");r("rating-trend",e.reviews.trend),o("rating-chart",t.averageRating||[]);var c=e.reviews.total||0,d=document.getElementById("total-reviews"),s=document.getElementById("reviews-subtext");d&&(d.textContent=c);s&&(s.textContent=e.reviews.positive+" positive, "+e.reviews.negative+" negative");r("reviews-trend",e.reviews.trend),o("reviews-chart",t.reviewsPositive||[]);var l=e.requests.clickRate||0,u=document.getElementById("click-rate"),v=document.getElementById("click-subtext");u&&(u.textContent=l.toFixed(1)+"%");v&&(v.textContent=e.requests.clicked+" of "+e.requests.sent+" clicked");r("click-trend",e.requests.clickTrend),o("click-chart",t.clickRate||[]);var m=e.requests.conversionRate||0,f=document.getElementById("conversion-rate"),g=document.getElementById("conversion-subtext");f&&(f.textContent=m.toFixed(1)+"%");g&&(g.textContent=e.requests.rated+" of "+e.requests.sent+" completed");r("conversion-trend",e.requests.conversionTrend),o("conversion-chart",t.conversionRate||[])}(t,n)}).catch(function(e){console.error("Failed to load analytics:",e),alert("Failed to load analytics data. Please try again.")})}function r(e,t){var n=document.getElementById(e);if(n){if(!t)return n.textContent="--",void(n.className="kpi-trend neutral");var a=t>0?"▲":t<0?"▼":"●",i=t>0?"+":"";n.textContent=a+" "+i+t.toFixed(1)+"%",n.className="kpi-trend "+(t>0?"positive":t<0?"negative":"neutral")}}function o(e,t){"function"==typeof createSparkline&&createSparkline(e,t)}function c(){var t=new URLSearchParams;n&&t.append("location",n),fetch(e+"/timing-heatmap?"+t).then(function(e){return e.json()}).then(function(e){!function(e){var t=document.getElementById("heatmap-container");if(!t)return;if(!e||0===e.length)return void(t.innerHTML='<div class="heatmap-loading">No timing data available yet. Send more SMS requests to see performance patterns.</div>');for(var n=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],a=[],i=0;i<24;i++)a.push(i);var r={};e.forEach(function(e){var t=e.dayOfWeek+"-"+e.hourOfDay;r[t]={score:e.performanceScore||0,sent:e.requestsSent||0,clicked:e.requestsClicked||0,rated:e.requestsRated||0,clickRate:e.clickRate||0}});var o='<div class="heatmap-grid">';o+='<div class="heatmap-header"></div>',n.forEach(function(e){o+='<div class="heatmap-header">'+e+"</div>"}),a.forEach(function(e){var t=0===e?"12am":e<12?e+"am":12===e?"12pm":e-12+"pm";o+='<div class="heatmap-hour-label">'+t+"</div>",n.forEach(function(n,a){var i=r[a+1+"-"+e];if(i&&0!==i.sent){var c=i.score,d="empty";d=c>=80?"excellent":c>=60?"good":c>=40?"medium":c>=20?"low":"very-low";var s=n+" "+t+"\nSent: "+i.sent+"\nClicked: "+i.clicked+" ("+i.clickRate.toFixed(0)+"%)\nScore: "+c.toFixed(0);o+='<div class="heatmap-cell '+d+'" title="'+s+'">'+c.toFixed(0)+"</div>"}else o+='<div class="heatmap-cell empty" title="No data">—</div>'})}),o+="</div>",t.innerHTML=o}(e)}).catch(function(e){console.error("Failed to load timing heatmap:",e);var t=document.getElementById("heatmap-container");t&&(t.innerHTML='<div class="heatmap-loading">Failed to load timing data. Please try again.</div>')})}function d(e){return null==e?"--":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(e)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a(),window.AnalyticsDashboard={loadAnalyticsData:i,loadTimingHeatmap:c,formatCurrency:d}}();